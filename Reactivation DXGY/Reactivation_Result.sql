

-- new Reactivations Results Process

SET start_date = TO_DATE('2025-02-21');
SET end_date = DATEADD(DAY, 14, $start_date);
SET country1 = 'UK';
SET country2 = 'Ireland';

SELECT 
  A.DRIVER_ID,
  CLUSTER_NAME AS "Cluster",
  CITY_NAME AS "City",
  COUNT(OA_STATUS) ORDER_COUNT,
  SUM(CASE WHEN OA_STATUS = 'DELIVERED' AND TO_DATE(LOCAL_TIME_OA_CREATED_AT) BETWEEN $start_date AND DATEADD(DAY, (7 - DAYOFWEEK($start_date)), $start_date) THEN 1 ELSE 0 END) AS Orders_Week_1,
  SUM(CASE WHEN OA_STATUS = 'DELIVERED' AND TO_DATE(LOCAL_TIME_OA_CREATED_AT) BETWEEN DATEADD(DAY, (8 - DAYOFWEEK($start_date)), $start_date) AND DATEADD(DAY, (14 - DAYOFWEEK($start_date)), $start_date) THEN 1 ELSE 0 END) AS Orders_Week_2,
  SUM(CASE WHEN OA_STATUS = 'DELIVERED' AND TO_DATE(LOCAL_TIME_OA_CREATED_AT) BETWEEN DATEADD(DAY, (15 - DAYOFWEEK($start_date)), $start_date) AND $end_date THEN 1 ELSE 0 END) AS Orders_Week_3

FROM production.denormalised.denormalised_assignment A
  WHERE COUNTRY_NAME IN ($country1, $country2)
  AND OA_STATUS = 'DELIVERED'  
  AND TO_DATE(LOCAL_TIME_OA_CREATED_AT) BETWEEN $start_date AND $end_date
  AND A.DRIVER_ID IS NOT NULL
  AND A.DRIVER_ID IN
    (
       
        '934531','719735','943041','724732','338438','825702','681588','871253','601479','937877','247614','639871','919719','875203','621873','644716','160138','640646','875272','828510','816658','932954','489633','797236','884382','772462','748829','15441','290425','811255','637043','483769','813108','908370','624982','564484','940519','179638','631364','190405','859260','427520','857059','423526','864756','16238','772393','886423','609586','941207','464105','426059','426758','832984','811263','705388','934887','942654','443996','815819','939401','937930','229382','815742','619219','908450','733687','393930','876110','877752','744524','62310','131540','830120','415880','623810','815544','817236','833215','396649','17815','497579','171272','940520','669140','884469','440179','877435','174094','934873','241774','809542','859262','615134','821795','863874','863878','912773','332765','619584','876777','944647','199956','290675','936129','673354','748812','764187','833218','838553','938618','292394','314102','817238','930965','497995','939403','949025','463959','451417','941061','943335','313662','937583','121606','797219','817102','817127','830776','439063','891170','930960','933406','940056','948511','637012','763830','794109','852818','421960','448860','881079','914204','933947','950231','178344','327373','562322','618033','631741','827264','413081','934876','173877','468684','768339','391289','899635','822826','863876','940112','327184','808546','827753','338079','415777','427610','933040','937584','939758','944138','940528','893213','748838','916541','837601','422604','776277','863694','795429','332755','411619','827131','937232','523638','643163','941985','875781','746223','783722','814634','842921','934167','290581','808331','358082','837642','926321','363061','851080','491828','27986','931865','734356','833119','819987','464171','932969','920231','566062','621818','60429','249238','411389','13912','551519','623918','928901','522339','848984','591509','624267','851078','778121','283521','874836','934071','922099','833841','314120','942066','301313','428479','892916','929378','325672','814130','691966','451710','749240','731694','940234','162863','933588','944361','565187','516368','940240','932716','946475','556101','896335','827052','951116','459947','932638','591455','534678','473554','818108','956896','467741','626835','952552','592987','910752','609681','743279','929210','940416','372328','898667','929186','499329','595215','727975','930432','404390','922070','757891','767774','357867','864622','833815','850319','951505','721340','850629','926253','751655','171505','452643','870783','922825','94285','714965','832728','365820','878087','833719','843529','906198','932837','564429','632007','933587','842778','431043','315081','30356','269513','102124','681229','817519','698320','304729','440221','853016','460515','692170','665168','744559','689409','725748','880816','444365','895772','848155','160991','880212','864686','680920','443403','97854','908217','412716','147868','455457','881501','406242','557572','819793','751490','587461','895105','675267','752240','677125','653277','817375','551531','669722','564213','852104','830121','661281','119338','738471','88288','431876','757296','390856','674251','666688','608906','850056','516243','869119','728237','363901','828049','710715','439041','845418','931566','676398','909526','296554','355748','595428','365075','247385','697222','646289','745056','754879','779600','779494','616756','753789','924015','704103','341333','668083','292143','41546','783585','929575','869105','636422','302553','690256','849456','415425','457617','810297','848780','905367','733771','893365','905365','849334','882839','853039','347677','635405','732360','555806','664197','440596','722498','777467','722094','215594','303038','366086','852114','849070','29357','432374','851832','724006','291535','356082','589508','635785','27438','681926','894639','499557','686018','680470','367967','364411','519861','901286','672266','239294','568965','671188','704187','338976','109361','391558','912465','895771','926978','156549','414238','931135','443453','693177','850334','55499','833633','849499','440678','646045','876656','228566','419493','443804','115878','164736','415750','714586','243170','570449','228155','518022','724567','643757','485978','931509','849464','683215','691156','293881','431641','700161','113473','844505','863403','782307','879826','892854','178313','660843','890879','853961','551312','616119','902434','937029','554067','649914','902467','884696','509572','737397','646629','518858','713692','752779','427857','443533','883631','897214','121284','459918','678717','439796','552409','647079','333164','540584','485684','732558','643742','679733','855420','849218','154005','551103','652176','568764','940540','300926','524390','525944','647247','13271','158356','337165','846330','872700','245163','467227','491470','874296','777704','822030','523840','881362','239169','240683','515752','845086','651012','872872','883605','715269','344892','815036','178533','852659','280774','557556','562740','929727','390851','925180','334619','908231','678826','338362','428498','159430','559920','853370','645285','851518','661544','854250','510453','301208','607691','741005','931160','12602','129766','615922','871464','155798','817921','408647','854378','558138','710353','495979','18524','245287','745398','572329','59934','458944','191261','846422','423426','851003','262468','649663','3141','645332','667623','946397','868834','906236','8373','45651','510165','386036','672764','338682','281143','695884','850026','551316','893938','953442','667723','845524','676575','883545','680616','388967','457450','731969','364989','552536','354897','114460','528149','376336','943298','493926','302679','245003','485646','875351','239469','638310','931857','168843','904607','522497','452778','904086','469715','881642','910596','424373','836451','371951','479535','515915','644359','661889','722395','392432','889567','687234','387942','723','890375','554822','713694','882935','408808','724406','135693','629045','444163','854929','138428','353220','915531','160996','448620','548657','473498','519109','567509','848183','846333','850699','894646','75','432018','673615','715377','365081','410980','335187','936788','111018','354754','883076','884357','926025','100693','559914','951792','624548','366901','428257','921949','850345','906161','910682','881607','910646','947138','764105','430725','649740','679624','697069','108473','248566','878730','524746','736059','420136','430443','547297','565224','27047','158010','485970','552895','614443','428001','918683','221150','556361','871327','883547','723419','337894','555768','660539','662743','666895','888958','679898','927732','303107','667355','528575','873695','886919','366922','300856','846848','419524','427185','227606','691376','706817','844808','357342','386078','494349','392879','132307','472234','351492','448289','597586','736474','824372','891031','355126','35641','229412','681001','335960','941595','12951','820725','897524','239715','642516','667574','874660','68640','88910','557178','561537','676316','400471','415519','241296','309091','931491','493845','388870','945806','927230','954502','138426','545196','558965','670284','416740','422872','454120','885302','8536','242644','662302','716057','450364','875324','659903','883542','907749','703501','748521','871096','889742','904894','498194','549398','561049','626433','813798','854247','355766','938740','76997','525343','619106','650600','4332','468884','568936','229856','651937','397610','891975','153879','507072','566528','568416','641988','368120','893317','931116','643752','850638','405830','471875','620215','953132','453702','860782','876724','149381','159049','645288','731210','875339','945973','950324','49385','146409','493664','499797','509602','710827','936671','674296','853279','881609','225928','493141','506314','397058','919116','933336','496213','497959','503933','546927','347553','402173','937008','943305','185764','679061','695195','418258','428830','186242','467251','543331','679265','346730','166593','485526','498622','614350','678532','391631','411977','412543','432145','904225','13494','230770','239517','529330','570862','646033','660866','668160','668531','357681','924744','943736','944207','516238','558398','676702','725751','906246','946963','159034','482039','726602','737085','848732','849167','344453','364965','366411','875706','890582','67405','461559','495896','496234','553373','558803','649003','685173','345211','419551','870864','101466','136474','302272','564312','646120','660931','713444','939174','942583','945950','125710','158978','616862','343408','875808','877315','906423','418348','942652','32007','128640','159840','505543','303052','643796','684644','896713','25725','232872','462088','505744','559146','635305','644927','648974','732279','413784','415944','890378','920134','938676','41344','151667','177706','237565','286648','557156','643411','649662','778916','337481','389004','423670','869416','904502','917235','949465','9782','69530','116355','156754','244255','464024','552063','565527','647248','666596','666694','704548','855488','338481','375615','454942','886594','890579','906655','908138','933349','945621','954686','121402','491150','545962','591877','644741','675075','680453','731974','732570','849936','381410','945829','945957','226850','228354','515032','522233','550516','552610','652042','748151','748438','773567','851706','415040','450793','452352','918452','937230','950310','953309','1616','40836','73596','236055','497429','516389','517348','642216','645354','652187','710101','729653','731179','844242','348435','388058','392289','888962','897055','239491','469298','491388','507314','694641','737019','748160','853219','342055','406065','455092','887293','891976','940107','940786','941817','956372','3911','20470','113491','152999','161556','288910','485259','507613','513689','513776','514422','516119','523794','540928','547900','302262','644291','683206','702165','709360','854139','854380','335654','338221','348405','381875','881603','906240','940163','941875','943102','951785','952661','432213','787002','285240','440642','431865','763674','649188','467209','848005','101920','785234','392251','905677','868795','508722','509984','117323','99640','692667','292936','894377','556119','543490','626','542743','846767','419947','630112','151219','475068','234398','223149','553252','164467','183975','670346','931839','646525','811003','601819','635811','612550','338426','296445','347596','881219','364405','572031','894376','597648','356593','627956','659540','689078','546157','140113','751740','856640','943978','182770','496215','650849','891293','681121','702812','1379','635766','874043','643642','754881','347404','498125','697966','199219','364415','905609','659191','71145','923662','737022','892406','392568','728790','188459','556169','401500','463726','639633','737045','896266','929070','144542','471137','688047','786295','550995','501086','868783','855438','557024','881858','854002','361938','870161','873707','793659','669804','729245','117454','654635','65891','423147','672522','270500','68444','465686','928090','166035','646860','1845','238096','675298','332684','892343','64780','689238','334139','889347','705403','419743','325808','716283','883712','937205','71571','365810','770023','421252','694443','697722','849854','528560','885892','892207','508990','721790','891971','893872','467507','351747','177763','335793','896399','767878','903645','445271','363870','649936','521467','757114','346411','522221','37137','561253','943397','343902','773169','518017','139993','243699','736583','162487','356631','924916','381025','147402','349325','388932','886603','782308','331793','949803','845833','513671','524294','441549','569592','343434','584893','737588','83183','921569','500426','378820','443614','728385','505950','377453','679188','678356','740484','226440','527625','546934','22734','354024','711363','367862','875619','879995','1318','249224','647360','884530','889323','251049','695337','241734','395005','624250','467736','686502','935846','921134','893071','15614','21506','570179','741754','505517','596842','933282','927248','418150','176623','554533','296502','715042','783681','167868','670298','697150','461678','818990','419741','752698','902277','882443','22577','672472','844184','881497','475122','915063','540632','633636','345874','651090','755298','450559','338027','237938','633184','878037','784195','647911','926949','217254','465987','241571','521952','230832','635079','680577','225247','363958','478157','680999','240909','617276','355874','591790','303535','569944','644991','882355','946213','751797','882153','229790','944528','354756','903746','650158','346624','944947','237789','491606','239085','898913','28851','713309','431927','491434','497340','510611','601102','681655','704739','929540','521690','702663','701653','367676','246268','692974','852833','414780','523385','154327','778098','495375','784484','893357','643318','854154','954677','483545','633328','376243','868986','883187','908549','878939','549584','444382','894704','231581','409254','425111','940088','183084','355868','413278','911462','653110','171935','937404','695715','813795','872220','769805','340037','222835','894383','347934','282056','463395','696068','736189','739614','850271','346954','934810','404687','414379','493213','695246','853060','477603','345561','238411','628094','363927','941424','643929','808506','671210','871449','480066','781501','492431','517668','472694','903515','849564','355805','417167','282160','643739','753001','925850','470075','712398','883286','902443','633685','422038','891081','667152','588723','931899','174823','227555','850739','60182','517231','719151','343515','420610','701330','660953','661155','436631','901374','460838','549487','661350','908211','473357','931339','944395','545290','696172','397465','683427','904517','233873','645632','869509','896628','903750','524155','412588','563735','666035','954357','543500','714611','874838','683514','722241','869901','343414','720913','736054','334799','201616','602748','825691','419923','922717','941608','100656','492360','355825','4969','485866','869726','907029','450854','953303','265898','644633','339188','933412','714039','752293','851053','853351','415904','425350','667644','677998','772167','334065','898520','664175','569687','343872','540884','871089','878812','893372','159126','522352','461097','508039','352669','954597','152899','570148','668263','881947','891504','943899','145241','681032','697383','378326','427341','479228','342382','414401','424731','424835','227088','745045','423710','876728','923001','763164','556428','715645','940001','392509','440027','570935','638091','640517','674429','736945','698368','724724','886593','12011','136014','491461','896797','872195','566640','462903','472120','496067','654677','679500','7826','308544','557139','768623','333849','427074','452935','300463','488832','343468','455217','883073','954564','9989','884351','894652','816598','416964','225571','378022','243419','227650','679827','767883','348862','925842','937777','662971','347365','391161','934770','151128','474871','550052','893011','908406','924757','937048','944560','594114','606764','644905','346431','418171','424885','940447','952994','526449','630129','690244','690391','718805','412141','874535','881374','931816','288407','549533','598141','882058','940570','117473','549688','645484','846759','66884','184359','502594','546909','558122','570178','664949','928430','186186','603230','957726','203639','509671','643977','845834','388024','402616','952747','140108','156796','295329','488853','751771','772726','852910','854937','409513','443545','934461','22437','137700','173876','248887','740443','419017','455145','950101','614208','763255','446860','448846','872490','884978','953903','133411','497409','540831','643388','686201','688189','443851','924754','952618','39460','235999','460097','561506','645016','652071','107301','552185','654596','662179','905327','954562','18459','139040','493538','507399','651999','686743','720485','421444','428529','428820','443509','27724','728256','755622','347885','381343','925888','940087','953552','18729','224524','251305','518740','608482','644879','710344','729609','335485','391570','452037','879607','910650','947711','8948','14347','284242','478202','492286','528033','550972','571152','644279','676093','679449','706794','455065','882967','937053','22934','231855','236352','246014','459547','502160','671173','681504','725902','366998','416203','881462','931658','942458','1234','1728','1818','31332','101697','113816','650912','651057','667717','781720','815548','429391','452769','875158','879273','927509','58209','183162','243830','478937','633061','710721','741769','851225','334695','883980','939800','956880','137178','196407','495874','507414','529357','540820','543484','556358','556381','556968','633181','649905','666372','667648','673809','680695','693203','703286','723913','747507','824773','846391','851319','364227','420956','421177','925225','952910','957950','13079','28529','43381','155721','167161','177400','241036','242752','464500','473470','487138','491765','494359','513591','597671','611067','635440','639390','666924','697504','757621','759951','848546','381174','411526','413725','443739','447151','453025','455629','882064','882069','894267','898132','922169','927613','930230','67558','105527','157847','227653','231823','232935','247012','281553','287356','459318','469542','485212','485775','524478','524921','558252','597627','633081','640256','651055','656586','662181','667575','669122','672335','690248','697130','702195','715334','725156','748748','763197','844178','854012','347865','364641','379237','379961','381014','401589','427147','432861','436461','450432','905681','907582','925552','926844','934231','937199','938050','953039','711496','881162','176811','406634','651930','676214','869196','644673','880160','505453','564335','923032','624719','246863','568581','176719','886917','287377','563939','896147','313110','336445','568877','424786','882851','337242','137589','546917','660362','614250','230866','425959','499776','757653','491441','432215','302661','338039','659366','658580','491303','650966','854900','240281','158','545320','893165','817515','808578','425355','156352','300472','542611','906630','295597','771923','667197','876530','492784','356965','314654','237592','469348','932560','507458','328744','871251','102241','161433','397049','757695','889519','393244','854679','564777','568375','517167','908940','748383','520844','908171','482421','249075','868842','932464','536187','387185','412721','722521','303850','609975','390901','110850','673130','558578','528324','338349','923665','500286','505599','41365','480503','432053','660908','939125','235270','475047','523163','902684','635046','827756','741543','391659','688646','653719','424218','647612','934389','378775','741088','623221','415869','530472','443065','198337','741084','426007','678645','550177','644321','1139','548289','699901','736457','874620','881087','836458','232413','427833','881537','43438','484750','506097','393307','931908','237187','678729','501103','349174','248','377534','926887','645989','936264','934823','557939','674403','333186','869327','468077','936756','101973','492082','744044','878057','157720','924618','464209','882968','548728','766531','458991','505546','342223','378925','292328','916218','571625','449461','224160','748045','935579','930829','937373','481146','699721','545346','147514','681532','883565','468782','646189','336547','426357','9569','923753','473117','720869','463913','644692','926898','237583','952641','494449','887060','10722','546034','690454','435497','441450','81732','546780','721808','732068','39559','295122','474251','846392','934110','246990','474109','174410','518518','682508','923837','470244','306401','12029','149107','158347','587305','469980','540751','737586','358793','415229','509521','926628','878826','884001','937304','937634','227054','493741','521570','745182','435947','896698','641823','328094','442635','878639','937026','660944','160595','508876','511541','598274','703296','440685','441320','178674','233021','242476','645738','690069','347061','439155','104178','243530','611340','615987','681172','714943','396997','441326','908412','916078','951952','289410','506728','551064','672400','732064','769751','774855','338453','364022','444663','906676','924041','957785','52583','141759','236240','473909','479264','519059','309479','315638','618323','618635','637388','639133','742970','347080','394085','928126','357360','343272','690945','872139','336825','871047','668642','892785','462653','585101','680197','552359','636158','675659','890580','566037','945318','683291','922368','902325','483986','942354','512910','891802','509508','633043','720103','334988','845009','881486','925231','172227','694154','163414','543377','227223','422510','506239','368107','135','925239','387283','367950','889511','514083','732568','392147','419366','412208','878222','905354','522181','509650','881656','103389','765873','775870','428398','467843','491613','734450','880878','441565','521334','335288','909954','883298','203232','632977','872775','853973','636851','557070','565400','649813','507465','487654','557417','811407','608628','681201','893959','557589','242121','37306','549431','722860','537900','660813','887559','473415','480369','352086','522237','293093','499852','878620','697583','895924','550135','382225','853053','439786','661558','562307','710605','333973','931401','179687','875629','601847','448323','451964','480169','511530','340996','926169','393437','944182','659151','500464','825808','427182','444258','706641','827007','884076','883375','337775','505403','508748','869434','381867','432152','871026','670626','391400','481205','556455','560944','653218','680767','681080','601092','907661','540691','123415','364541','442957','644713','668167','549719','723336','645305','839370','292497','441594','876316','327462','522529','688401','721730','465538','667958','135806','654415','939304','147316','248344','883314','469883','775559','442671','662213','732977','478270','657589','269912','763191','519333','503293','907575','886123','890241','337510','877384','336923','874925','65407','693761','671367','710362','303015','776152','679807','777173','843996','542687','397147','640907','873317','907318','474295','641662','744502','896909','644606','291080','436646','557202','334082','916315','468250','415367','908170','518397','440227','164491','339159','455580','618617','152073','378927','881857','473729','62147','244405','476024','818425','647710','524049','694178','163430','152506','553875','905360','443458','473860','500834','570624','739602','906535','950106','431936','472048','523712','758844','427002','945009','677739','350000','492252','878507','614921','437785','929141','755649','240422','483746','713310','325399','666917','386122','673575','462975','742591','670155','595610','675251','59427','677082','294585','303587','903553','153223','469160','548020','101138','478696','618811','880625','917676','429321','723404','245098','767668','515433','869110','950788','175505','282901','492072','455235','512440','473109','542700','737021','473402','873873','289186','506243','511543','512141','886962','503314','340887','89583','426920','631185','713150','410455','418335','163171','672295','740787','822319','473081','466539','498379','618989','450193','517965','618056','343174','438657','540933','688237','614102','451096','150575','545909','569828','593423','745384','854371','902338','426058','346228','157993','480517','814063','945002','494068','395944','686154','1098','881156','924800','937618','233952','872445','875293','389380','509313','619313','698463','609165','432065','526989','937416','564064','664443','22354','134217','633076','185773','497944','379850','392220','730605','419866','938828','343648','366029','884225','32023','462167','356639','527674','570102','945076','952965','557778','725284','954568','427405','890577','849691','364507','402187','927948','887962','281978','922267','545277','666577','634986','339054','671400','145013','232624','952082','153670','240553','465424','465990','562813','873085','564365','633088','688164','431836','907271','182715','638333','646602','656526','662222','767269','452637','935624','938411','95734','335035','387414','524389','550209','761927','347696','307481','726670','757863','889405','542592','666051','710844','846216','374809','67477','171301','552006','615264','507443','529828','568829','759618','883002','941866','627445','907824','931885','59233','485711','680171','396111','455307','952942','132941','157814','231686','659928','702170','844563','917111','926881','158349','195331','517077','523644','683581','486618','489259','617939','638219','666169','381200','402216','549983','645077','647478','674488','443628','31793','674273','366394','910292','952843','956919','472402','481700','674470','756058','853001','937390','61505','485783','491417','680499','219086','229861','629820','635864','714007','425732','444147','935893','937115','27591','464005','475258','536964','338588','869395','939217','948491','185903','226267','243901','469204','356340','881144','890372','60076','71963','159064','231655','467180','526807','586908','645873','676572','343621','868481','528506','615029','367923','412196','416437','443083','909815','945313','952770','109163','113461','670134','731201','423638','908880','222484','460731','540734','557319','618259','621132','709294','776941','337690','455188','489682','494050','326705','676718','686426','697093','698433','744794','749432','763104','889906','900146','946841','951702','956423','4300','61353','472970','518593','680869','741031','344251','395564','411873','881371','888820','955203','9555','132728','150720','463356','474296','477849','530591','662296','664962','704311','711353','725976','345695','423803','902279','924972','115031','296120','459820','500952','545915','564155','741894','748539','749528','393087','439385','457472','929843','951832','52073','113829','188358','226733','487650','558246','640743','713288','830410','332544','351626','420719','861813','873366','890751','902344','906534','939070','939523','57529','476187','481751','509293','644915','651303','670506','757909','353250','412156','440681','869158','889801','902414','929138','936308','936672','950699','951852','3885','131638','233891','506376','570498','656581','676362','685903','686599','704411','721464','737034','751783','359652','375089','382170','440665','893139','906278','907583','907789','916617','926126','926144','930787','954610','957672','51057','83499','157560','483745','516358','521579','546104','547972','551994','557723','616120','617876','628951','644596','645792','674732','707561','827805','331581','343327','348315','378707','381795','389324','415162','417688','441536','446884','872189','906467','907827','925041','935552','939814','946215','949868','233895','844822','921409','549581','880947','290653','293834','897364','442918','567779','191830','205312','327089','733787','244238','312920','116712','887101','757935','827331','91058','900542','243185','381254','872371','476027','514128','472577','934946','144866','644680','868907','903634','827047','644643','875920','483681','849958','723825','546950','449482','892537','142644','944616','485055','335155','791686','782384','328600','698200','424891','693688','881606','483390','523926','543462','877270','880626','850262','904611','732723','564339','236093','686554','747504','390878','678880','879885','820572','397006','550407','509015','889488','826588','436925','876214','290401','234875','37807','937309','225587','335797','342021','226049','701768','545354','349087','469192','851999','585011','476248','878931','67266','890403','473791','364429','227986','567617','289397','549486','658345','898310','190741','898290','451817','951795','881966','234608','397007','427294','397021','63892','664926','678058','880547','881223','338699','296657','897081','767280','620786','347085','880814','726773','551083','655404','880250','883178','476754','644612','850561','248935','919427','432505','614416','526438','643976','499595','651042','882423','232863','924944','671615','927276','594503','445522','243977','697007','908141','450526','691897','444052','928071','724284','331718','557165','923501','498039','485716','905292','465383','757089','423536','747683','308548','295929','343159','441579','926264','637818','227697','634809','492818','676395','561564','903545','698580','336190','475053','723427','904293','133504','508080','647236','337247','891932','906227','774845','937277','505167','601855','706128','826728','239331','242116','109229','557529','178300','693669','332998','237129','586967','347665','679254','295682','357558','365394','466038','335329','883126','420836','635818','884629','464536','38284','881764','889364','638800','884100','48402','709289','783519','559723','491410','699664','155194','695224','698763','883617','217744','651931','671832','335156','875966','685252','767259','467992','768985','302534','697737','908883','940165','172773','481211','880081','627537','423994','919373','186721','507524','887092','470405','99653','458198','644776','679162','149807','424153','559534','892445','747731','851036','644572','194459','854014','344608','549724','342545','558298','818697','851149','931242','938051','478624','569349','652034','751775','344246','644709','711421','421758','429315','376328','543507','937619','314907','665394','425785','441110','110578','288729','477107','856395','940976','945203','477183','893148','930464','671179','445112','882942','697001','697623','864238','922096','521958','680379','848163','880799','124799','545965','110208','666523','376286','926625','473474','415789','232250','364620','234871','424689','942069','607823','913609','767316','877814','476055','288434','528400','562815','165860','514817','516232','679219','416625','863640','7309','543496','703919','567708','346530','936329','121517','674835','391520','441748','883697','235307','517270','416844','452614','884006','816931','452995','223563','482285','501303','548019','556202','587568','660935','686812','922796','850554','896903','907648','667950','719720','334233','879813','901194','688398','777317','928550','632978','634816','331102','420809','201991','243882','524379','770125','782226','838683','348977','393996','940906','227842','307466','698245','850682','506433','601530','627890','676707','686036','850555','267075','463414','565565','685282','695617','352055','102968','483088','505257','302400','664976','686799','879673','886398','925480','940533','460124','480430','484852','569040','661793','676721','736958','748558','374064','428017','429033','882503','925907','940975','171365','223937','709979','820443','424349','923099','500802','560823','586802','706119','350367','408360','235166','474084','510215','541660','548776','633322','729679','750923','833118','336471','421871','926155','939902','217499','564248','568557','630451','639768','666268','720985','721204','846388','851795','410867','411998','882958','144436','166420','492084','567472','619339','429293','431829','869392','880099','883435','887292','924803','934740','58545','189283','246396','285003','480432','499592','561343','562721','665903','686592','726126','819030','844623','853480','337922','350317','423893','427077','449478','881701','933277','14504','59524','220087','468573','484797','508522','509086','645636','730697','759205','783450','362136','364930','393158','452115','892547','893429','907622','915386','918187','931486','133488','171961','182759','640708','672247','828373','852539','333533','338429','349030','392880','878938','880538','880822','937290','236492','238760','246855','476020','508025','556651','561838','570113','703565','760430','852122','343632','395990','439067','444068','952462','34903','75798','76725','159371','196266','198025','237579','286442','293484','459706','465753','466501','481412','492760','497371','515580','520639','546041','569926','612309','614597','643593','660529','667812','674348','675265','678654','681288','717547','725916','743101','744572','846453','853482','334953','337438','387454','396975','415700','429177','442963','868156','876439','880178','880721','890457','893080','926351','938404','939086','941924','387994','875655','871311','240017','750133','869601','924578','431997','645218','191864','837715','889335','234911','845491','448260','844481','303860','882842','302930','563126','667149','128078','554057','412464','296658','680035','517536','883392','552283','941298','12330','884253','555067','453892','380580','234180','217476','644617','747107','855241','719790','483712','462560','686927','882213','452322','560752','876709','739318','863508','913773','496206','667147','741920','460946','365458','674785','331950','112044','238151','644396','701577','643873','415151','139105','731499','731623','888104','98133','846832','251485','288505','714029','909806','659181','327503','459550','847799','725363','482356','14471','656045','740819','882552','506847','878006','685372','685240','446937','158318','418261','235425','561098','371609','367880','695176','932087','884975','869460','455583','875171','777848','334664','714576','919477','883485','110446','719761','851989','149374','876731','767350','671629','540271','408926','78942','871192','673089','666029','443140','671839','884720','924423','96996','569046','426182','896920','553709','497268','523622','850210','909083','897352','908594','678953','500900','307488','688219','161915','943076','170032','884452','907755','146958','540645','492440','844208','628445','225614','427233','741528','411870','642455','439829','516831','233793','661580','390865','456805','407458','853499','906830','874920','235805','301041','347943','432904','446854','414329','230565','455214','564302','414152','511243','380518','697234','814504','850664','403297','436989','500460','423801','666440','338522','467835','646163','95383','237203','941186','467969','676763','773564','896612','517067','665506','933013','722346','775593','281849','719716','401931','905170','500398','645478','679828','491746','502588','666535','882734','227994','427150','430406','872773','499732','880824','33338','880722','488326','703374','719032','236489','618711','440583','882621','925384','617284','711481','850994','877880','566625','645298','850872','242079','871848','897367','338197','498730','469203','165807','349706','871495','2875','914686','612118','641508','872226','751707','350910','566943','529838','743972','643957','864276','423023','944212','459824','633206','661344','854717','886753','450044','228021','429540','236368','649893','893994','938384','939270','746181','698902','716255','543176','883503','522374','338223','415073','500781','686749','301236','629633','871091','880517','13858','143160','748413','846299','73808','647549','545436','549679','709913','713160','422321','662968','142222','493806','757318','335986','433156','63463','137556','561111','419646','427632','469292','530807','659041','678827','160935','645555','508165','548615','229414','248159','739586','349125','521420','831099','226086','504081','741273','882944','232267','824835','880718','228625','754874','237198','100504','692959','721496','418842','567526','394823','870810','905414','933141','618387','425377','112873','683357','716037','338595','442061','430949','351215','503926','386934','265820','688211','711482','372359','525539','343884','137255','432169','458981','882892','468838','506662','524811','691171','737066','683543','954902','130391','528225','933568','719974','908267','512433','686674','27001','593036','391404','755644','479005','741120','402596','952635','723381','824209','890240','210531','342088','444479','391086','884968','167877','718007','550929','952652','906326','676822','737620','381042','416145','661135','852936','36109','337685','412113','560597','949614','521182','563694','564333','783683','122520','33635','854388','337985','885889','491338','558392','684360','695631','939706','655403','694221','394483','429479','883992','719436','379426','876158','633248','644304','447759','291274','849781','449198','944985','288518','462076','543283','687423','454659','591131','678020','456674','488766','521754','767242','795641','443248','457455','949966','829906','884985','483059','708924','879332','929243','953439','644255','630977','819797','386652','100189','428736','886916','101385','234937','242782','605945','691234','432127','329277','884165','144526','243008','526860','699533','731227','681115','850623','597636','451859','903541','507232','525401','685882','429618','890881','528524','647387','407407','460156','844958','367859','59107','690911','923280','848330','48132','543168','289297','748049','724274','408029','617515','721131','454095','237576','693515','720120','409388','434957','754951','884005','884174','121494','694194','330617','444778','178669','645895','685275','821817','382302','412852','97040','491977','748166','339149','147638','293822','472037','477063','507563','519338','645722','678923','849933','14617','156875','461136','500371','645308','737264','348490','868766','104192','160176','161457','482861','523862','663212','775185','886865','923081','236357','722380','936603','176638','498991','521380','689109','391708','456014','880719','236482','560773','882145','939143','141627','478077','338099','376303','228404','491429','506627','524174','528902','693966','764106','410401','420013','881856','496382','507461','645502','690196','699964','847422','883186','927225','933381','51079','647591','883597','896615','924391','946214','151104','651915','671763','692342','853464','382153','869223','956514','490412','517718','597503','703376','391738','392078','911621','557620','569846','692389','709697','879680','903586','942194','68194','458292','466555','720419','755637','784259','343827','450985','884350','888830','940405','949899','186021','262151','477918','507902','534048','549690','556647','557573','635451','714084','851223','240273','477607','545950','325346','649860','656461','660763','672468','684568','730645','882448','884598','889569','891404','900533','925294','176794','285669','496013','521257','552092','599542','654686','719757','328122','422192','881637','937313','71633','174724','528476','528592','557746','558552','679563','849903','853763','442077','879781','891725','925179','931423','953928','6493','65741','285043','293546','458737','560547','568519','661019','834750','846785','412637','444140','884003','74536','495977','540962','648950','698226','850231','339202','339206','367749','390672','428512','430170','440078','448439','864560','888811','926193','947386','950266','951880','80122','144467','174594','227964','527517','305795','682332','849106','338085','346494','421592','938351','944968','951897','38891','139012','221182','471997','523520','543028','552385','600544','640137','644220','658626','673297','698538','720444','779257','787258','847039','849922','347244','371617','419995','424533','427067','432540','437727','874308','884308','892096','922795','925994','942163','950275','9817','34006','468348','498140','557790','563626','643517','652103','674471','679879','683059','684429','690327','692216','703192','709949','710309','732719','845626','334081','413845','414920','863331','875254','882207','882837','886586','886923','923822','929319','933416','933422','956994','30239','67168','151588','459956','460324','473479','485136','485404','497948','516359','518301','524145','524323','548290','553891','564251','602215','638606','650910','652102','676578','690385','692596','701455','710648','780836','818954','833431','841823','846147','857478','336159','340028','345013','354309','423864','424915','433364','447675','449526','450270','870857','882610','883569','889724','919191','926000','926091','927997','931272','941257','942569','944494','945173','946197','950264','953026','82','2451','4907','26710','27002','45035','45848','123382','128781','132576','149742','157739','282529','289085','293107','467087','470642','491103','497764','509341','512393','529842','549614','550420','556188','560555','570250','590711','618797','618808','642982','648169','656003','719054','721316','753160','768408','826366','845123','849268','343899','359616','365844','367675','376852','382548','406639','428879','432326','439818','441434','443186','453199','880406','881621','886782','921373','924608','924760','925993','926029','926107','927648','927992','928500','939528','939532','942723','942793','946414','946704','950271','950677','953330','953338','953403','954910','690133','823310','616508','658509','627293','881716','833871','773429','820107','608759','447964','938784','816477','773442','831313','907320','821792','420694','437666','508317','681910','920791','847743','555879','553439','625434','819297','889563','197977','681916','545180','547381','846965','811828','53409','236392','676114','428615','770645','764412','936852','341453','434964','820220','822305','955085','553274','824338','764403','894821','628430','495962','695725','614462','524937','681905','541497','565262','935060','466301','553318','847754','337456','492030','934673','568297','818942','462326','430469','818808','904389','30364','414582','297838','660412','451585','491466','879883','291901','609015','759160','627044','770640','281089','493725','345515','557796','651409','823781','845227','518462','628983','395424','935052','584702','817523','439083','885671','933632','944007','815039','283431','746027','825988','231170','240651','564169','885490','894655','494030','699895','912604','451629','937278','705426','726668','53948','939153','891078','268738','815690','888107','937275','198532','569921','628698','846497','414612','38300','310684','814542','814545','941833','145279','613895','846061','858449','473786','680286','709582','815038','815641','822310','838633','847738','879370','891167','942138','270380','283818','814549','390911','440978','939115','541502','614046','719727','936342','937294','951811','106563','813456','848135','344655','453861','937273','119472','717321','811830','818625','818813','825793','414589','439626','908419','930016','33796','147965','200070','292510','462372','564078','629140','737186','771006','811833'

    )   
GROUP BY 
  A.DRIVER_ID, CITY_NAME, CLUSTER_NAME
ORDER BY 
  ORDER_COUNT DESC, A.DRIVER_ID, CITY_NAME, CLUSTER_NAME
;  


SELECT A.COUNTRY_NAME, B.CLUSTER_NAME, A.ONBOARDING_AREA, A.CITY_NAME, SUM(B.ORDERS_DELIVERED) AS ORDERS_DELIVERED, A.ZONE_CODE

FROM SCRATCH.RIDERS.ZONE_DRN_ID_TO_ONBOARDING_AREA A
LEFT JOIN PRODUCTION.AGGREGATE.AGG_ZONE_DELIVERY_METRICS_HOURLY B ON A.ZONE_CODE = B.ZONE_CODE

WHERE B.START_OF_PERIOD_LOCAL >= DATEADD(DAY, -7, CURRENT_DATE)
    AND B.ORDERS_DELIVERED > 0

GROUP BY A.COUNTRY_NAME, A.ONBOARDING_AREA, A.CITY_NAME, B.CLUSTER_NAME, A.ZONE_CODE
    
ORDER BY A.COUNTRY_NAME DESC, A.CITY_NAME, B.CLUSTER_NAME, ORDERS_DELIVERED DESC, A.ZONE_CODE, A.ONBOARDING_AREA

;



WITH BASE AS (
  SELECT 
    A.COUNTRY_NAME,
    B.CLUSTER_NAME,
    A.ONBOARDING_AREA,
    A.CITY_NAME,
    A.ZONE_CODE,
    SUM(B.ORDERS_DELIVERED) AS ORDERS_DELIVERED
  FROM SCRATCH.RIDERS.ZONE_DRN_ID_TO_ONBOARDING_AREA A
  LEFT JOIN PRODUCTION.AGGREGATE.AGG_ZONE_DELIVERY_METRICS_HOURLY B 
    ON A.ZONE_CODE = B.ZONE_CODE
  WHERE B.START_OF_PERIOD_LOCAL >= DATEADD(DAY, -7, CURRENT_DATE)
    AND B.ORDERS_DELIVERED > 0
  GROUP BY A.COUNTRY_NAME, A.ONBOARDING_AREA, A.CITY_NAME, B.CLUSTER_NAME, A.ZONE_CODE
),
AGG_ORDERS AS (
  SELECT 
    COUNTRY_NAME,
    CLUSTER_NAME,
    ONBOARDING_AREA,
    CITY_NAME,
    SUM(ORDERS_DELIVERED) AS ORDERS_DELIVERED
  FROM BASE
  GROUP BY COUNTRY_NAME, CLUSTER_NAME, ONBOARDING_AREA, CITY_NAME
),
ZONES_IN_CLUSTER AS (
  SELECT 
    CLUSTER_NAME,
    LISTAGG(DISTINCT ZONE_CODE, ', ') WITHIN GROUP (ORDER BY ZONE_CODE) AS ZONES_IN_CLUSTER
  FROM BASE
  GROUP BY CLUSTER_NAME
),
AREAS_IN_CLUSTER AS (
  SELECT 
    CLUSTER_NAME,
    LISTAGG(ONBOARDING_AREA, ', ') WITHIN GROUP (ORDER BY SUM_ORDERS DESC) AS RAW_AREA_LIST
  FROM (
    SELECT 
      CLUSTER_NAME,
      ONBOARDING_AREA,
      SUM(ORDERS_DELIVERED) AS SUM_ORDERS
    FROM BASE
    GROUP BY CLUSTER_NAME, ONBOARDING_AREA
  ) AREA_ORDERS
  GROUP BY CLUSTER_NAME
),
ZONES_IN_AREA AS (
  SELECT 
    ONBOARDING_AREA,
    LISTAGG(DISTINCT ZONE_CODE, ', ') WITHIN GROUP (ORDER BY ZONE_CODE) AS ZONES_IN_ONBOARDING_AREA
  FROM BASE
  GROUP BY ONBOARDING_AREA
)

SELECT 
  A.COUNTRY_NAME,
  A.CLUSTER_NAME,
  A.ONBOARDING_AREA,
  A.CITY_NAME,
  A.ORDERS_DELIVERED,
  AC.RAW_AREA_LIST AS AREAS_IN_CLUSTER,
  Z.ZONES_IN_CLUSTER,
  ZA.ZONES_IN_ONBOARDING_AREA

FROM AGG_ORDERS A
LEFT JOIN ZONES_IN_CLUSTER Z ON A.CLUSTER_NAME = Z.CLUSTER_NAME
LEFT JOIN AREAS_IN_CLUSTER AC ON A.CLUSTER_NAME = AC.CLUSTER_NAME
LEFT JOIN ZONES_IN_AREA ZA ON A.ONBOARDING_AREA = ZA.ONBOARDING_AREA

ORDER BY A.COUNTRY_NAME DESC, A.CITY_NAME, A.CLUSTER_NAME, A.ORDERS_DELIVERED DESC, A.ONBOARDING_AREA;