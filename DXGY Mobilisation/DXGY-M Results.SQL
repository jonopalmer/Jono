
SELECT 
  DRIVER_ID,
  COUNT(STATUS) ORDER_COUNT,
  DATE(LOCAL_TIME_OA_CREATED_AT) AS "XP_DATE",
  ZONE_CODE AS "Zone",
  CITY_NAME AS "City", COUNTRY_NAME AS "Country",
CASE 
    WHEN DAYOFWEEK(LOCAL_TIME_OA_CREATED_AT) = 5 
        AND EXTRACT(HOUR FROM LOCAL_TIME_OA_CREATED_AT) BETWEEN 18 AND 21
    THEN 'Friday SP'
    WHEN DAYOFWEEK(LOCAL_TIME_OA_CREATED_AT) = 6 
        AND EXTRACT(HOUR FROM LOCAL_TIME_OA_CREATED_AT) BETWEEN 18 AND 21
    THEN 'Saturday SP' ELSE NULL
END AS Period
FROM PRODUCTION.denormalised.orders 
  WHERE COUNTRY_NAME IN ('UK', 'Ireland')
  AND ZONE_CODE IN ('ESL', 'ESLE', 'RMSY',  'WCH', 'GGDP', 'OTF', 'SEV', 'WRSW', 'GOD', 'GUI', 'SAN')        
  AND STATUS = 'DELIVERED'  
  AND (
    (LOCAL_TIME_OA_CREATED_AT BETWEEN TO_TIMESTAMP('2024-11-01 18:00') AND TO_TIMESTAMP('2024-11-01 21:00')) OR
    (LOCAL_TIME_OA_CREATED_AT BETWEEN TO_TIMESTAMP('2024-11-02 18:00') AND TO_TIMESTAMP('2024-11-02 21:00')))
  AND DRIVER_ID IS NOT NULL
GROUP BY 
  DRIVER_ID, CITY_NAME, COUNTRY_NAME, PERIOD, XP_DATE, ZONE_CODE    
ORDER BY 
  CITY_NAME, DRIVER_ID, ZONE_CODE, XP_DATE
;  
