WITH CTE AS(
SELECT
    driver_id,
    (TO_CHAR(TO_DATE(DATE), 'YYYY-MM-DD')) AS "Date",
    HOURS_WORKED_PEAK_DINNER,
    CNT_PEAK_DINNER_ORDERS
FROM production.denormalised.driver_accounting_daily
WHERE DATE IN ('2024-11-15', '2024-11-16')
    AND CUR_COUNTRY = 'UK'
    ORDER BY 1,2
)

SELECT 
  A.DRIVER_ID,
  COUNT(STATUS) ORDER_COUNT,
  DATE(LOCAL_TIME_OA_CREATED_AT) AS "XP_DATE",
  ZONE_CODE AS "Zone",
  CITY_NAME AS "City", COUNTRY_NAME AS "Country",
CASE 
    WHEN DAYOFWEEK(LOCAL_TIME_OA_CREATED_AT) = 5 
        AND EXTRACT(HOUR FROM LOCAL_TIME_OA_CREATED_AT) BETWEEN 18 AND 21
    THEN 'Friday SP'
    WHEN DAYOFWEEK(LOCAL_TIME_OA_CREATED_AT) = 6 
        AND EXTRACT(HOUR FROM LOCAL_TIME_OA_CREATED_AT) BETWEEN 18 AND 21
    THEN 'Saturday SP' ELSE NULL
END AS Period,
 HOURS_WORKED_PEAK_DINNER, 
 CNT_PEAK_DINNER_ORDERS
FROM PRODUCTION.denormalised.orders A
LEFT JOIN CTE ON CTE.driver_id = A.DRIVER_ID AND CTE."Date" = DATE(LOCAL_TIME_OA_CREATED_AT)
  WHERE COUNTRY_NAME IN ('UK', 'Ireland')
  AND ZONE_CODE IN ('ESL', 'ESLE', 'RMSY',  'WCH', 'GGDP', 'OTF', 'SEV', 'WRSW', 'GOD', 'GUI', 'SAN')        
  AND STATUS = 'DELIVERED'  
  AND (
    (LOCAL_TIME_OA_CREATED_AT BETWEEN TO_TIMESTAMP('2024-11-15 18:00') AND TO_TIMESTAMP('2024-11-15 21:00')) OR
    (LOCAL_TIME_OA_CREATED_AT BETWEEN TO_TIMESTAMP('2024-11-16 18:00') AND TO_TIMESTAMP('2024-11-16 21:00')))
  AND A.DRIVER_ID IS NOT NULL
GROUP BY 
  A.DRIVER_ID, CITY_NAME, COUNTRY_NAME, PERIOD, XP_DATE, ZONE_CODE, HOURS_WORKED_PEAK_DINNER, CNT_PEAK_DINNER_ORDERS    
ORDER BY 
  CITY_NAME, A.DRIVER_ID, ZONE_CODE, XP_DATE
;  
